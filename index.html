<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Notes PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        textarea { width: 100%; height: 150px; font-size: 16px; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; }
        #installBtn { display: none; background: #007bff; margin-bottom: 20px; }
        .note-card { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 4px; background: #f9f9f9; }
        .ios-prompt { display: none; background: #eef; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccd; }
    </style>
</head>
<body>

    <button id="installBtn">ðŸ“² Install App to Home Screen</button>
    <div id="iosPrompt" class="ios-prompt">
        To install on iOS: Tap the <strong>Share</strong> icon and select <strong>"Add to Home Screen"</strong>.
    </div>

    <h1>My Local Notes</h1>
    
    <textarea id="noteInput" placeholder="Write a note..."></textarea>
    <button onclick="saveNote()">Save Note</button>

    <div id="notesList"></div>

    <script>
        // --- 1. SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        // --- 2. INSTALLATION LOGIC ---
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        const iosPrompt = document.getElementById('iosPrompt');

        // Check for iOS to show manual instructions
        const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

        if (isIos && !isStandalone) {
            iosPrompt.style.display = 'block';
        }

        // Capture the Android/Desktop install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block'; // Show our custom button
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // --- 3. INDEXEDDB DATABASE LOGIC ---
        let db;
        const request = indexedDB.open("NotesDB", 1);

        // Create Schema
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("notes")) {
                db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            loadNotes(); // Load notes when DB is ready
        };

        // Save Function
        function saveNote() {
            const text = document.getElementById('noteInput').value;
            if (!text) return;

            const transaction = db.transaction(["notes"], "readwrite");
            const store = transaction.objectStore("notes");
            store.add({ text: text, date: new Date().toLocaleDateString() });

            transaction.oncomplete = () => {
                document.getElementById('noteInput').value = "";
                loadNotes();
            };
        }

        // Load Function
        function loadNotes() {
            const list = document.getElementById('notesList');
            list.innerHTML = "";
            
            const transaction = db.transaction(["notes"], "readonly");
            const store = transaction.objectStore("notes");
            const request = store.getAll();

            request.onsuccess = () => {
                // Display notes in reverse order (newest first)
                request.result.reverse().forEach(note => {
                    const div = document.createElement("div");
                    div.className = "note-card";
                    div.innerHTML = `<strong>${note.date}</strong><br>${note.text}`;
                    list.appendChild(div);
                });
            };
        }
    </script>
</body>
</html>
